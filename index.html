<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인터랙티브 원두 가격 계산기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (Stone, Amber) -->
    <!-- Application Structure Plan: A responsive, two-column dashboard-style calculator. The left column contains all user inputs (costs, margins), grouped logically. The right column displays the calculated results and a dynamic doughnut chart visualizing the cost breakdown. This structure provides immediate feedback and allows users to easily conduct "what-if" analysis by adjusting inputs and seeing the impact on the price and cost structure instantly, making the complex calculation process intuitive and user-friendly. A modal for calculation breakdown is added for transparency, and a new modal for detailed roasting labor cost calculation is also introduced for better granularity. A separate settings modal is added to allow users to configure default input values. A new "Price History" section is added below the main results to store and display saved final prices. -->
    <!-- Visualization & Content Choices: Report Info: Cost components (bean cost, loss, labor, etc.), VAT, detailed labor cost, default input values, price history. Goal: Allow users to calculate and understand their pricing structure, including VAT, see step-by-step calculations, precisely determine roasting labor costs, customize default input values for convenience, and record/review past calculations. Viz/Presentation: Interactive form with number inputs and sliders. Dynamic text fields for results. A dynamic doughnut chart for visualizing cost proportions (including VAT). Modal popups for detailed calculation breakdown, roasting labor cost calculation, and default settings. A list for price history entries with customizable names, price, profit, and margin displayed. Interaction: All input fields trigger immediate recalculation and chart update. Dedicated buttons trigger both the main calculation breakdown modal and the new roasting labor cost calculation modal. A new button triggers the default settings modal. A "Save" button records the current final price to local storage. A "Clear History" button clears all saved records. Justification: This interactive approach provides instant visual feedback, step-by-step transparency, granular control over specific cost components, enhanced user convenience through customizable defaults, and historical tracking for comparative analysis or record-keeping, now with improved overview in the history. Library/Method: Vanilla JS for logic, Chart.js for the doughnut chart on a Canvas element, localStorage for client-side persistence of price history. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .input-group label {
            @apply block text-sm font-medium text-gray-600 mb-1;
        }
        .input-field {
            /* Changed background to bg-gray-100 for better visibility and added rounded-md for rounded corners */
            @apply w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 bg-gray-100 rounded-md;
        }
        .slider-value {
            @apply text-lg font-bold text-amber-700 ml-2;
        }
        .result-card {
            @apply bg-white p-6 rounded-lg shadow-lg;
        }
        .result-label {
            @apply text-lg text-gray-600;
        }
        .result-value {
            @apply text-3xl font-bold text-gray-900;
        }
        .final-price {
            @apply text-5xl font-extrabold text-amber-600;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-button {
            @apply absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold;
        }
        .breakdown-step {
            @apply border-b border-gray-200 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0;
        }
    </style>
</head>
<body class="bg-stone-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12 relative">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">원두 가격 계산기</h1>
            <p class="mt-2 text-lg text-gray-600">원가와 마진을 입력하여 원두의 최종 판매 가격을 산정하세요.</p>
            <button id="openSettingsBtn" class="absolute top-0 right-0 md:top-2 md:right-2 px-4 py-2 bg-gray-100 text-gray-600 rounded-md shadow-sm hover:bg-gray-200 transition-colors text-sm">
                ⚙️ 설정
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Input Section -->
            <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 border-b pb-2 text-gray-700">1. 비용 입력</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 원재료비 -->
                    <div class="space-y-4 p-4 border rounded-lg bg-stone-50">
                        <h3 class="font-bold text-lg text-gray-700">원재료비</h3>
                        <div class="input-group">
                            <label for="greenBeanCost">생두 단가 (kg당)</label>
                            <input type="number" id="greenBeanCost" class="input-field" value="15000">
                        </div>
                        <div class="input-group">
                            <label for="roastingLoss">로스팅 감량률 <span id="roastingLossValue" class="slider-value">15%</span></label>
                            <input type="range" id="roastingLoss" min="5" max="25" value="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-600">
                        </div>
                    </div>

                    <!-- 가공비 -->
                    <div class="space-y-4 p-4 border rounded-lg bg-stone-50">
                        <h3 class="font-bold text-lg text-gray-700">가공비 (판매 단위당)</h3>
                         <div class="input-group">
                            <label for="unitWeight">판매 단위 (g)</label>
                            <input type="number" id="unitWeight" class="input-field" value="200">
                        </div>
                        <div class="input-group">
                            <label for="roastingLabor">로스팅 인건비</label>
                            <div class="flex items-center">
                                <input type="number" id="roastingLabor" class="input-field flex-grow" value="300">
                                <button id="openLaborCostModalBtn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md shadow-sm hover:bg-gray-300 transition-colors text-sm">
                                    계산
                                </button>
                            </div>
                        </div>
                         <div class="input-group">
                            <label for="packagingCost">포장재 비용</label>
                            <input type="number" id="packagingCost" class="input-field" value="500">
                        </div>
                    </div>

                    <!-- 추가 비용 및 마진 -->
                    <div class="md:col-span-2 space-y-4 p-4 border rounded-lg bg-stone-50">
                        <h3 class="font-bold text-lg text-gray-700">수수료 및 마진</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="input-group">
                                <label for="cardFee">카드 결제 수수료 <span id="cardFeeValue" class="slider-value">2.5%</span></label>
                                <input type="range" id="cardFee" min="0" max="5" step="0.1" value="2.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-600">
                            </div>
                            <div class="input-group">
                                <label for="vatRate">부가세 (VAT) <span id="vatRateValue" class="slider-value">10%</span></label>
                                <input type="range" id="vatRate" min="0" max="20" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-600">
                            </div>
                            <div class="input-group">
                                <label for="targetMargin">목표 마진율 <span id="targetMarginValue" class="slider-value">40%</span></label>
                                <input type="range" id="targetMargin" min="10" max="80" value="40" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-600">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Section -->
            <div class="lg:col-span-2 space-y-6">
                <div class="result-card text-center">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-700">2. 최종 판매가</h2>
                    <p class="result-label">권장 소비자 가격</p>
                    <div class="flex items-center justify-center gap-2">
                        <p id="finalPrice" class="final-price my-2">0 원</p>
                    </div>
                     <p class="text-sm text-gray-500">(부가세, 카드 수수료 포함)</p>
                     
                     <div class="mt-4">
                        <label for="historyNameInput" class="sr-only">기록 이름</label>
                        <input type="text" id="historyNameInput" class="input-field text-center mb-2" placeholder="기록 이름 (선택 사항)">
                        <button id="savePriceBtn" class="px-6 py-2 bg-green-500 text-white rounded-md shadow-md hover:bg-green-600 transition-colors w-full">
                            현재 가격 기록하기
                        </button>
                    </div>

                     <button id="showBreakdownBtn" class="mt-4 px-6 py-2 bg-amber-500 text-white rounded-md shadow-md hover:bg-amber-600 transition-colors w-full">
                        계산 과정 보기
                    </button>
                </div>

                <div class="result-card">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">가격 구성 요소</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">총 원가 (단위당)</span>
                            <span id="totalCost" class="font-bold text-lg">0 원</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">이윤 (마진)</span>
                            <span id="profit" class="font-bold text-lg">0 원</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">부가세</span>
                            <span id="vatAmount" class="font-bold text-lg">0 원</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">결제 수수료</span>
                            <span id="feeAmount" class="font-bold text-lg">0 원</span>
                        </div>
                    </div>
                    <div class="mt-6">
                         <div class="chart-container">
                            <canvas id="costStructureChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Price History Section -->
        <section class="mt-8 bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-gray-700">3. 가격 기록</h2>
                <button id="clearHistoryBtn" class="px-4 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-colors text-sm">
                    모두 삭제
                </button>
            </div>
            <ul id="priceHistoryList" class="space-y-3">
                <li class="text-gray-500 text-center py-4">기록된 가격이 없습니다.</li>
            </ul>
        </section>
    </div>

    <!-- Calculation Breakdown Modal -->
    <div id="breakdownModal" class="modal-overlay">
        <div class="modal-content relative">
            <button id="closeModalBtn" class="modal-close-button">&times;</button>
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-700">계산 과정</h3>
            <div id="breakdownContent" class="text-gray-700 space-y-3">
                <!-- Calculation steps will be inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- Labor Cost Calculation Modal -->
    <div id="laborCostModal" class="modal-overlay">
        <div class="modal-content relative">
            <button id="closeLaborCostModalBtn" class="modal-close-button">&times;</button>
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-700">로스팅 인건비 산정</h3>
            <div class="text-gray-700 space-y-4">
                <!-- This span will be dynamically updated by JS -->
                <p class="text-sm text-gray-600"><span id="laborCostUnitWeightDisplay">판매 단위(200g)</span> 당 로스팅 인건비를 계산합니다.</p>
                <div class="input-group">
                    <label for="hourlyWage">시급 (원)</label>
                    <input type="number" id="hourlyWage" class="input-field" value="9860">
                </div>
                <div class="input-group">
                    <label for="roastingTimeMinutes">1회 로스팅 시간 (분)</label>
                    <input type="number" id="roastingTimeMinutes" class="input-field" value="20">
                </div>
                <div class="input-group">
                    <label for="batchSizeKg">1회 로스팅 원두량 (kg)</label>
                    <input type="number" id="batchSizeKg" class="input-field" value="5">
                </div>
                <div class="mt-6 p-4 bg-amber-50 rounded-lg border border-amber-200">
                    <p class="text-lg text-gray-700">판매 단위(<span id="laborCostResultUnitWeight">200g</span>) 당 로스팅 인건비:</p>
                    <p id="calculatedLaborCost" class="text-2xl font-bold text-amber-700 mt-1">0 원</p>
                </div>
                <button id="applyLaborCostBtn" class="w-full mt-6 px-6 py-3 bg-amber-600 text-white rounded-md shadow-md hover:bg-amber-700 transition-colors text-lg">
                    적용하기
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content relative">
            <button id="closeSettingsBtn" class="modal-close-button">&times;</button>
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-700">기본값 설정</h3>
            <div class="text-gray-700 space-y-4">
                <p class="text-sm text-gray-600">계산기 입력 필드의 초기 기본값을 설정합니다.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="defaultGreenBeanCost">생두 단가 (kg당)</label>
                        <input type="number" id="defaultGreenBeanCost" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="defaultRoastingLoss">로스팅 감량률 (%)</label>
                        <input type="number" id="defaultRoastingLoss" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="defaultUnitWeight">판매 단위 (g)</label>
                        <input type="number" id="defaultUnitWeight" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="defaultRoastingLabor">로스팅 인건비 (판매 단위당)</label>
                        <input type="number" id="defaultRoastingLabor" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="defaultPackagingCost">포장재 비용 (판매 단위당)</label>
                        <input type="number" id="defaultPackagingCost" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="defaultCardFee">카드 결제 수수료 (%)</label>
                        <input type="number" id="defaultCardFee" class="input-field" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="defaultVatRate">부가세 (VAT) (%)</label>
                        <input type="number" id="defaultVatRate" class="input-field">
                    </div>
                    <div class="input-group">
                        <label for="defaultTargetMargin">목표 마진율 (%)</label>
                        <input type="number" id="defaultTargetMargin" class="input-field">
                    </div>
                </div>
                <button id="applySettingsBtn" class="w-full mt-6 px-6 py-3 bg-amber-600 text-white rounded-md shadow-md hover:bg-amber-700 transition-colors text-lg">
                    적용하기
                </button>
            </div>
        </div>
    </div>

    <footer class="mt-8 py-4 text-center text-gray-500 text-sm">
        <p>만든 사람: <a href="https://www.instagram.com/rangxmin" target="_blank" class="text-amber-600 hover:underline">@rangxmin</a></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = {
                greenBeanCost: document.getElementById('greenBeanCost'),
                roastingLoss: document.getElementById('roastingLoss'),
                unitWeight: document.getElementById('unitWeight'),
                roastingLabor: document.getElementById('roastingLabor'),
                packagingCost: document.getElementById('packagingCost'),
                cardFee: document.getElementById('cardFee'),
                vatRate: document.getElementById('vatRate'),
                targetMargin: document.getElementById('targetMargin')
            };

            const displays = {
                roastingLossValue: document.getElementById('roastingLossValue'),
                cardFeeValue: document.getElementById('cardFeeValue'),
                vatRateValue: document.getElementById('vatRateValue'),
                targetMarginValue: document.getElementById('targetMarginValue'),
                finalPrice: document.getElementById('finalPrice'),
                totalCost: document.getElementById('totalCost'),
                profit: document.getElementById('profit'),
                vatAmount: document.getElementById('vatAmount'),
                feeAmount: document.getElementById('feeAmount')
            };

            const breakdownElements = {
                modal: document.getElementById('breakdownModal'),
                content: document.getElementById('breakdownContent'),
                showBtn: document.getElementById('showBreakdownBtn'),
                closeBtn: document.getElementById('closeModalBtn')
            };

            const laborCostModalElements = {
                modal: document.getElementById('laborCostModal'),
                openBtn: document.getElementById('openLaborCostModalBtn'),
                closeBtn: document.getElementById('closeLaborCostModalBtn'),
                hourlyWage: document.getElementById('hourlyWage'),
                roastingTimeMinutes: document.getElementById('roastingTimeMinutes'),
                batchSizeKg: document.getElementById('batchSizeKg'),
                calculatedLaborCostDisplay: document.getElementById('calculatedLaborCost'),
                applyBtn: document.getElementById('applyLaborCostBtn'),
                unitWeightDisplay: document.getElementById('laborCostUnitWeightDisplay'),
                resultUnitWeightDisplay: document.getElementById('laborCostResultUnitWeight')
            };

            const settingsModalElements = {
                modal: document.getElementById('settingsModal'),
                openBtn: document.getElementById('openSettingsBtn'),
                closeBtn: document.getElementById('closeSettingsBtn'),
                applyBtn: document.getElementById('applySettingsBtn'),
                defaultGreenBeanCost: document.getElementById('defaultGreenBeanCost'),
                defaultRoastingLoss: document.getElementById('defaultRoastingLoss'),
                defaultUnitWeight: document.getElementById('defaultUnitWeight'),
                defaultRoastingLabor: document.getElementById('defaultRoastingLabor'),
                defaultPackagingCost: document.getElementById('defaultPackagingCost'),
                defaultCardFee: document.getElementById('defaultCardFee'),
                defaultVatRate: document.getElementById('defaultVatRate'),
                defaultTargetMargin: document.getElementById('defaultTargetMargin')
            };

            const historyElements = {
                saveBtn: document.getElementById('savePriceBtn'),
                nameInput: document.getElementById('historyNameInput'),
                list: document.getElementById('priceHistoryList'),
                clearBtn: document.getElementById('clearHistoryBtn')
            };

            let costChart;
            let currentBreakdownData = {};

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(value);
            };

            const calculate = () => {
                const greenBeanCost = parseFloat(inputs.greenBeanCost.value) || 0;
                const roastingLoss = parseFloat(inputs.roastingLoss.value) || 0;
                const unitWeightG = parseFloat(inputs.unitWeight.value) || 0;
                const unitWeightKg = unitWeightG / 1000;
                
                const roastingLabor = parseFloat(inputs.roastingLabor.value) || 0;
                const packagingCost = parseFloat(inputs.packagingCost.value) || 0;

                const cardFee = parseFloat(inputs.cardFee.value) || 0;
                const vatRate = parseFloat(inputs.vatRate.value) || 0;
                const targetMargin = parseFloat(inputs.targetMargin.value) || 0;
                
                displays.roastingLossValue.textContent = `${roastingLoss}%`;
                displays.cardFeeValue.textContent = `${cardFee.toFixed(1)}%`;
                displays.vatRateValue.textContent = `${vatRate}%`;
                displays.targetMarginValue.textContent = `${targetMargin}%`;

                if (laborCostModalElements.unitWeightDisplay) {
                    laborCostModalElements.unitWeightDisplay.textContent = `판매 단위(${unitWeightG}g)`;
                }
                if (laborCostModalElements.resultUnitWeightDisplay) {
                    laborCostModalElements.resultUnitWeightDisplay.textContent = `${unitWeightG}g`;
                }

                let roastedBeanCostPerKg = 0;
                if (1 - roastingLoss / 100 > 0) {
                    roastedBeanCostPerKg = greenBeanCost / (1 - roastingLoss / 100);
                }
                
                const materialCostPerUnit = roastedBeanCostPerKg * unitWeightKg;
                const processingCostPerUnit = roastingLabor + packagingCost;
                
                const totalCostPerUnit = materialCostPerUnit + processingCostPerUnit;

                let priceBeforeVATAndFee = 0;
                if (1 - targetMargin / 100 > 0) {
                    priceBeforeVATAndFee = totalCostPerUnit / (1 - targetMargin / 100);
                }
                const profitAmount = priceBeforeVATAndFee - totalCostPerUnit;

                const vatAmount = priceBeforeVATAndFee * (vatRate / 100);
                const priceIncludingVAT = priceBeforeVATAndFee + vatAmount;

                let finalPrice = 0;
                if (1 - cardFee / 100 > 0) {
                    finalPrice = priceIncludingVAT / (1 - cardFee / 100);
                }
                const feeAmount = finalPrice - priceIncludingVAT;

                currentBreakdownData = {
                    greenBeanCost,
                    roastingLoss,
                    unitWeightG,
                    roastedBeanCostPerKg,
                    materialCostPerUnit,
                    roastingLabor,
                    packagingCost,
                    processingCostPerUnit,
                    totalCostPerUnit,
                    targetMargin,
                    priceBeforeVATAndFee,
                    profitAmount,
                    vatRate,
                    vatAmount,
                    priceIncludingVAT,
                    cardFee,
                    finalPrice,
                    feeAmount
                };

                displays.totalCost.textContent = formatCurrency(totalCostPerUnit);
                displays.profit.textContent = formatCurrency(profitAmount);
                displays.vatAmount.textContent = formatCurrency(vatAmount);
                displays.feeAmount.textContent = formatCurrency(feeAmount);
                displays.finalPrice.textContent = formatCurrency(finalPrice);
                
                updateChart([materialCostPerUnit, processingCostPerUnit, profitAmount, vatAmount, feeAmount]);
            };
            
            const initChart = () => {
                const ctx = document.getElementById('costStructureChart').getContext('2d');
                costChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['원재료비', '가공비', '이윤', '부가세', '결제 수수료'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(120, 113, 108, 0.7)',
                                'rgba(217, 119, 6, 0.7)',
                                'rgba(251, 191, 36, 0.7)',
                                'rgba(76, 175, 80, 0.7)',
                                'rgba(252, 211, 77, 0.5)'
                            ],
                            borderColor: [
                                'rgb(120, 113, 108)', 
                                'rgb(217, 119, 6)',
                                'rgb(251, 191, 36)',
                                'rgb(76, 175, 80)', 
                                'rgb(252, 211, 77)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: "'Noto Sans KR', sans-serif"
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const updateChart = (data) => {
                if(costChart) {
                    costChart.data.datasets[0].data = data;
                    costChart.update();
                }
            };
            
            const showBreakdown = () => {
                const data = currentBreakdownData;
                let contentHTML = `
                    <div class="breakdown-step">
                        <p><strong>1. kg당 로스팅 후 생두 원가:</strong></p>
                        <p>${formatCurrency(data.greenBeanCost)} (생두 단가) / (1 - ${data.roastingLoss}% / 100) = <strong>${formatCurrency(data.roastedBeanCostPerKg)}/kg</strong></p>
                    </div>
                    <div class="breakdown-step">
                        <p><strong>2. 판매 단위당 (예: ${data.unitWeightG}g) 원재료비:</strong></p>
                        <p>${formatCurrency(data.roastedBeanCostPerKg)} (로스팅 후 kg당 원가) * ${data.unitWeightG / 1000} kg = <strong>${formatCurrency(data.materialCostPerUnit)}</strong></p>
                    </div>
                    <div class="breakdown-step">
                        <p><strong>3. 판매 단위당 가공비:</strong></p>
                        <p>${formatCurrency(data.roastingLabor)} (로스팅 인건비) + ${formatCurrency(data.packagingCost)} (포장재 비용) = <strong>${formatCurrency(data.processingCostPerUnit)}</strong></p>
                    </div>
                    <div class="breakdown-step">
                        <p><strong>4. 판매 단위당 총 원가 (총 제조 비용):</strong></p>
                        <p>${formatCurrency(data.materialCostPerUnit)} (원재료비) + ${formatCurrency(data.processingCostPerUnit)} (가공비) = <strong>${formatCurrency(data.totalCostPerUnit)}</strong></p>
                    </div>
                    <div class="breakdown-step">
                        <p><strong>5. 목표 마진율 ${data.targetMargin}% 적용 가격 (부가세 및 수수료 미포함):</strong></p>
                        <p>${formatCurrency(data.totalCostPerUnit)} (총 원가) / (1 - ${data.targetMargin}% / 100) = <strong>${formatCurrency(data.priceBeforeVATAndFee)}</strong></p>
                        <p>이윤 (마진): ${formatCurrency(data.profitAmount)}</p>
                    </div>
                     <div class="breakdown-step">
                        <p><strong>6. 부가세 ${data.vatRate}% 적용 가격:</strong></p>
                        <p>${formatCurrency(data.priceBeforeVATAndFee)} * (1 + ${data.vatRate}% / 100) = <strong>${formatCurrency(data.priceIncludingVAT)}</strong></p>
                        <p>부가세 금액: ${formatCurrency(data.vatAmount)}</p>
                    </div>
                    <div class="breakdown-step">
                        <p><strong>7. 최종 판매가 (카드 수수료 ${data.cardFee}% 포함):</strong></p>
                        <p>${formatCurrency(data.priceIncludingVAT)} (부가세 포함 가격) / (1 - ${data.cardFee}% / 100) = <strong>${formatCurrency(data.finalPrice)}</strong></p>
                        <p>결제 수수료 금액: ${formatCurrency(data.feeAmount)}</p>
                    </div>
                `;
                breakdownElements.content.innerHTML = contentHTML;
                breakdownElements.modal.classList.add('show');
            };

            const hideBreakdown = () => {
                breakdownElements.modal.classList.remove('show');
            };

            const calculateLaborCost = () => {
                const hourlyWage = parseFloat(laborCostModalElements.hourlyWage.value) || 0;
                const roastingTimeMinutes = parseFloat(laborCostModalElements.roastingTimeMinutes.value) || 0;
                const batchSizeKg = parseFloat(laborCostModalElements.batchSizeKg.value) || 0;
                const unitWeightG = parseFloat(inputs.unitWeight.value) || 200;

                let laborCostPerUnit = 0;
                if (hourlyWage > 0 && roastingTimeMinutes > 0 && batchSizeKg > 0 && unitWeightG > 0) {
                    const roastingTimeHours = roastingTimeMinutes / 60;
                    const laborCostPerBatch = hourlyWage * roastingTimeHours;
                    const unitsPerBatch = (batchSizeKg * 1000) / unitWeightG;
                    
                    if (unitsPerBatch > 0) {
                        laborCostPerUnit = laborCostPerBatch / unitsPerBatch;
                    }
                }
                laborCostModalElements.calculatedLaborCostDisplay.textContent = formatCurrency(laborCostPerUnit);
                return laborCostPerUnit;
            };

            const showLaborCostModal = () => {
                laborCostModalElements.modal.classList.add('show');
                if (laborCostModalElements.unitWeightDisplay) {
                    laborCostModalElements.unitWeightDisplay.textContent = `판매 단위(${inputs.unitWeight.value}g)`;
                }
                if (laborCostModalElements.resultUnitWeightDisplay) {
                    laborCostModalElements.resultUnitWeightDisplay.textContent = `${inputs.unitWeight.value}g`;
                }
                calculateLaborCost();
            };

            const hideLaborCostModal = () => {
                laborCostModalElements.modal.classList.remove('show');
            };

            const applyLaborCost = () => {
                const calculatedValue = calculateLaborCost();
                inputs.roastingLabor.value = Math.round(calculatedValue);
                hideLaborCostModal();
                calculate();
            };

            const showSettingsModal = () => {
                // Populate settings modal with current input values
                settingsModalElements.defaultGreenBeanCost.value = inputs.greenBeanCost.value;
                settingsModalElements.defaultRoastingLoss.value = inputs.roastingLoss.value;
                settingsModalElements.defaultUnitWeight.value = inputs.unitWeight.value;
                settingsModalElements.defaultRoastingLabor.value = inputs.roastingLabor.value;
                settingsModalElements.defaultPackagingCost.value = inputs.packagingCost.value;
                settingsModalElements.defaultCardFee.value = inputs.cardFee.value;
                settingsModalElements.defaultVatRate.value = inputs.vatRate.value;
                settingsModalElements.defaultTargetMargin.value = inputs.targetMargin.value;
                
                settingsModalElements.modal.classList.add('show');
            };

            const hideSettingsModal = () => {
                settingsModalElements.modal.classList.remove('show');
            };

            const applySettings = () => {
                // Apply values from settings modal to main inputs
                inputs.greenBeanCost.value = settingsModalElements.defaultGreenBeanCost.value;
                inputs.roastingLoss.value = settingsModalElements.defaultRoastingLoss.value;
                inputs.unitWeight.value = settingsModalElements.defaultUnitWeight.value;
                inputs.roastingLabor.value = settingsModalElements.defaultRoastingLabor.value;
                inputs.packagingCost.value = settingsModalElements.defaultPackagingCost.value;
                inputs.cardFee.value = settingsModalElements.defaultCardFee.value;
                inputs.vatRate.value = settingsModalElements.defaultVatRate.value;
                inputs.targetMargin.value = settingsModalElements.defaultTargetMargin.value;
                
                hideSettingsModal();
                calculate(); // Recalculate main app with new defaults
            };

            // History functions
            const loadPriceHistory = () => {
                const history = JSON.parse(localStorage.getItem('priceHistory')) || [];
                historyElements.list.innerHTML = ''; // Clear current list
                if (history.length === 0) {
                    historyElements.list.innerHTML = '<li class="text-gray-500 text-center py-4">기록된 가격이 없습니다.</li>';
                    return;
                }
                history.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 bg-stone-50 rounded-md shadow-sm';
                    listItem.innerHTML = `
                        <div class="flex-1 w-full sm:w-auto mb-2 sm:mb-0">
                            <p class="font-bold text-gray-800 text-lg">${item.name || '이름 없음'}</p>
                            <p class="text-xs text-gray-500">${item.date}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center sm:space-x-4">
                            <p class="text-gray-700">판매가: <span class="font-semibold">${formatCurrency(item.finalPrice)}</span></p>
                            <p class="text-gray-700">이윤: <span class="font-semibold">${formatCurrency(item.profitAmount)}</span></p>
                            <p class="text-gray-700">마진율: <span class="font-semibold">${item.targetMargin}%</span></p>
                            <button class="text-amber-600 hover:underline text-sm mt-2 sm:mt-0" data-inputs='${JSON.stringify(item.inputs)}'>세부 정보</button>
                        </div>
                    `;
                    historyElements.list.appendChild(listItem);
                });
                addHistoryDetailListeners();
            };

            const saveCurrentPriceToHistory = () => {
                const finalPriceValue = parseFloat(currentBreakdownData.finalPrice) || 0;
                if (finalPriceValue === 0) {
                    // Optionally show a message that price is 0 and cannot be saved
                    return;
                }

                const history = JSON.parse(localStorage.getItem('priceHistory')) || [];
                const now = new Date();
                const dateTimeString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                const recordName = historyElements.nameInput.value.trim();
                
                const newEntry = {
                    name: recordName || `기록 ${dateTimeString}`,
                    finalPrice: finalPriceValue,
                    date: dateTimeString,
                    profitAmount: currentBreakdownData.profitAmount,
                    targetMargin: currentBreakdownData.targetMargin,
                    inputs: {
                        greenBeanCost: inputs.greenBeanCost.value,
                        roastingLoss: inputs.roastingLoss.value,
                        unitWeight: inputs.unitWeight.value,
                        roastingLabor: inputs.roastingLabor.value,
                        packagingCost: inputs.packagingCost.value,
                        cardFee: inputs.cardFee.value,
                        vatRate: inputs.vatRate.value,
                        targetMargin: inputs.targetMargin.value
                    }
                };
                history.unshift(newEntry);
                localStorage.setItem('priceHistory', JSON.stringify(history));
                loadPriceHistory();
                historyElements.nameInput.value = '';
            };

            const clearPriceHistory = () => {
                localStorage.removeItem('priceHistory');
                loadPriceHistory();
            };

            const addHistoryDetailListeners = () => {
                historyElements.list.querySelectorAll('button[data-inputs]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const inputsData = JSON.parse(event.target.dataset.inputs);
                        let detailHTML = `
                            <p class="breakdown-step"><strong>생두 단가:</strong> ${formatCurrency(inputsData.greenBeanCost)}/kg</p>
                            <p class="breakdown-step"><strong>로스팅 감량률:</strong> ${inputsData.roastingLoss}%</p>
                            <p class="breakdown-step"><strong>판매 단위:</strong> ${inputsData.unitWeight}g</p>
                            <p class="breakdown-step"><strong>로스팅 인건비:</strong> ${formatCurrency(inputsData.roastingLabor)} (판매 단위당)</p>
                            <p class="breakdown-step"><strong>포장재 비용:</strong> ${formatCurrency(inputsData.packagingCost)} (판매 단위당)</p>
                            <p class="breakdown-step"><strong>카드 결제 수수료:</strong> ${inputsData.cardFee}%</p>
                            <p class="breakdown-step"><strong>부가세:</strong> ${inputsData.vatRate}%</p>
                            <p class="breakdown-step"><strong>목표 마진율:</strong> ${inputsData.targetMargin}%</p>
                        `;
                        breakdownElements.content.innerHTML = `
                            <h3 class="text-xl font-bold mb-4">기록된 가격 세부 정보</h3>
                            ${detailHTML}
                        `;
                        breakdownElements.modal.classList.add('show');
                    });
                });
            };


            // Event Listeners for main inputs
            Object.values(inputs).forEach(input => {
                input.addEventListener('input', calculate);
            });

            // Event Listeners for Breakdown Modal
            breakdownElements.showBtn.addEventListener('click', showBreakdown);
            breakdownElements.closeBtn.addEventListener('click', hideBreakdown);
            breakdownElements.modal.addEventListener('click', (e) => {
                if (e.target === breakdownElements.modal) {
                    hideBreakdown();
                }
            });

            // Event Listeners for Labor Cost Modal
            laborCostModalElements.openBtn.addEventListener('click', showLaborCostModal);
            laborCostModalElements.closeBtn.addEventListener('click', hideLaborCostModal);
            laborCostModalElements.hourlyWage.addEventListener('input', calculateLaborCost);
            laborCostModalElements.roastingTimeMinutes.addEventListener('input', calculateLaborCost);
            laborCostModalElements.batchSizeKg.addEventListener('input', calculateLaborCost);
            laborCostModalElements.applyBtn.addEventListener('click', applyLaborCost);
            laborCostModalElements.modal.addEventListener('click', (e) => {
                if (e.target === laborCostModalElements.modal) {
                    hideLaborCostModal();
                }
            });

            // Event Listeners for Settings Modal
            settingsModalElements.openBtn.addEventListener('click', showSettingsModal);
            settingsModalElements.closeBtn.addEventListener('click', hideSettingsModal);
            settingsModalElements.applyBtn.addEventListener('click', applySettings);
            settingsModalElements.modal.addEventListener('click', (e) => {
                if (e.target === settingsModalElements.modal) {
                    hideSettingsModal();
                }
            });

            // Event Listeners for History
            historyElements.saveBtn.addEventListener('click', saveCurrentPriceToHistory);
            historyElements.clearBtn.addEventListener('click', clearPriceHistory);


            // Initial load and calculation
            initChart();
            calculate();
            loadPriceHistory(); // Load history on initial page load
        });
    </script>
</body>
</html>
